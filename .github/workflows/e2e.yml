name: E2E tests

# Required GitHub Secrets:
# - AUTH0_CLIENT_SECRET: Auth0 client secret
#
# Required GitHub Variables:
# - AUTH0_AUDIENCE: Auth0 API Audience (e.g., https://test-bookshelf-api.hiterm.dev)
# - AUTH0_DOMAIN: Auth0 domain (e.g., hiterm-bookshelf-test.us.auth0.com)
# - AUTH0_CLIENT_ID: Auth0 Machine to Machine Application Client ID
#
# Configuration:
# 1. Create a GitHub Environment (e.g., "e2e-test"):
#    - Go to Settings > Environments
#    - Add new environment "e2e-test"
#    - Add environment-specific variables and secrets
#
# 2. Set variables in the environment:
#    - Go to Settings > Environments > e2e-test > Environment variables
#    - Add: AUTH0_AUDIENCE, AUTH0_DOMAIN, AUTH0_CLIENT_ID
#
# 3. Set secrets in the environment:
#    - Go to Settings > Environments > e2e-test > Environment secrets
#    - Add: AUTH0_CLIENT_SECRET
#
# 4. For Dependabot updates:
#    - Go to Settings > Secrets and variables > Dependabot
#    - Add: AUTH0_CLIENT_SECRET (Dependabot only supports secrets, not variables)

on: [push]

jobs:
  e2e:
    name: End-to-end tests
    runs-on: ubuntu-latest
    environment: e2e-test
    env:
      DATABASE_URL: postgres://bookshelf:password@localhost:5432/bookshelf
      AUTH0_AUDIENCE: ${{ vars.AUTH0_AUDIENCE }}
      AUTH0_DOMAIN: ${{ vars.AUTH0_DOMAIN }}
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@1.93.1
      - uses: Swatinem/rust-cache@v2
      - name: Start Postgres service
        run: sudo systemctl start postgresql.service
      - name: Wait for Postgres
        run: |
          for i in {1..30}; do
            if pg_isready; then
              exit 0
            fi
            sleep 1
          done
          echo "::error::Postgres did not become ready in time" >&2
          exit 1
      - name: Create DB and user
        run: sudo -u postgres psql --command="CREATE USER bookshelf WITH SUPERUSER PASSWORD 'password'" --command="\du" postgres
      - name: Create DB
        run: sudo -u postgres createdb --owner=bookshelf bookshelf
      - name: Install sqlx-cli
        run: cargo install sqlx-cli --no-default-features --features postgres,rustls
      - name: Prepare database
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
        run: |
          sqlx database create
          sqlx migrate run
      - name: Start application server
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
          PORT: 8080
          ALLOWED_ORIGINS: 'http://localhost:8080'
          AUTH0_AUDIENCE: ${{ vars.AUTH0_AUDIENCE }}
          AUTH0_DOMAIN: ${{ vars.AUTH0_DOMAIN }}
        run: |
          cargo run > server.log 2>&1 &
          # Wait for server to be ready
          for i in {1..600}; do
            if curl -s http://localhost:8080/health > /dev/null; then
              echo "Server is ready"
              exit 0
            fi
            sleep 1
          done
          echo "::error::Server did not become ready in time"
          echo "--- Server log ---"
          cat server.log
          exit 1
      - name: Get Auth0 Access Token
        id: auth
        run: |
          set -euo pipefail
          RESPONSE=$(curl --fail --silent --show-error \
            --connect-timeout 10 --max-time 30 \
            --request POST \
            --url "https://${{ vars.AUTH0_DOMAIN }}/oauth/token" \
            --header 'content-type: application/json' \
            --data "{\"client_id\":\"${{ vars.AUTH0_CLIENT_ID }}\",\"client_secret\":\"${{ secrets.AUTH0_CLIENT_SECRET }}\",\"audience\":\"${{ vars.AUTH0_AUDIENCE }}\",\"grant_type\":\"client_credentials\"}" \
          )
          TOKEN=$(printf '%s' "$RESPONSE" | jq -r '.access_token // empty')
          if [ -z "$TOKEN" ]; then
            echo "::error::Auth0 token acquisition failed: empty access_token"
            exit 1
          fi

          # Mask token in logs
          echo "::add-mask::$TOKEN"

          echo "token=$TOKEN" >> "$GITHUB_OUTPUT"
      - name: Run tests
        env:
          TEST_SERVER_URL: http://localhost:8080
          TEST_JWT_TOKEN: ${{ steps.auth.outputs.token }}
        run: |
          cargo test -p bookshelf-e2e -- --test-threads=1 --include-ignored
